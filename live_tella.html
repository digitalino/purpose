<!DOCTYPE html>
<html>
<head>
  <title>ğŸ”´ Tella Live Room</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.agora.io/sdk/release/AgoraRTC_N.js"></script>
</head>
<body>
  <h2>Agora 1:1 Live Voice Chat</h2>
  <button id="goLive">ğŸ“¡ ë‚˜ ë¼ì´ë¸Œ ì‹œì‘</button>
  <button id="stopLive">ğŸ›‘ ë¼ì´ë¸Œ ì¢…ë£Œ</button>
  <button id="joinLive" style="display:none;">ğŸ”Š ë¼ì´ë¸Œ ì±„íŒ… ì°¸ì—¬</button>

  <script>
    // 1. Firebase ì„¤ì •
    var firebaseConfig = {
      apiKey: "AIzaSyDjG3SPJFkc9fI4O9HajkcEZiojl-5707Q",
      authDomain: "p1pus-92806.firebaseapp.com",
      databaseURL: "https://p1pus-92806-default-rtdb.firebaseio.com",
      projectId: "p1pus-92806",
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // 2. Agora ì„¤ì •
    const APP_ID = "cd2936823f4b4a73996b60c850e8eb98";
    const CHANNEL = "live-room";
    let client, localStream;

    // 3. ë¼ì´ë¸Œ ì‹œì‘ ë²„íŠ¼
    document.getElementById("goLive").onclick = () => {
      db.ref("tella_chat").set({
        isLive: true,
        updated: new Date().toISOString()
      });
      joinAgora();
    };

    // 4. ë¼ì´ë¸Œ ì¢…ë£Œ ë²„íŠ¼
    document.getElementById("stopLive").onclick = () => {
      db.ref("tella_chat").set({ isLive: false });
      if (client && localStream) {
        client.unpublish(localStream);
        localStream.close();
        client.leave();
      }
    };

    // 5. ë¼ì´ë¸Œ ìƒíƒœ ê°ì§€í•´ì„œ ë²„íŠ¼ ë³´ì—¬ì£¼ê¸°
    db.ref("tella_chat").on("value", (snap) => {
      const data = snap.val();
      const isLive = data && data.isLive;
      document.getElementById("joinLive").style.display = isLive ? "inline-block" : "none";
    });

    // 6. ì°¸ê°€ì ì¡°ì¸
    document.getElementById("joinLive").onclick = () => joinAgora();

    function joinAgora() {
      client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
      client.init(APP_ID, () => {
        client.join(null, CHANNEL, null, (uid) => {
          localStream = AgoraRTC.createStream({ audio: true, video: false });
          localStream.init(() => {
            client.publish(localStream);
          });
        });
      });
    }
  </script>
</body>
</html>
